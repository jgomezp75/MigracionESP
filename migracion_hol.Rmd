---
title: "Limpieza y Filtrado e-Preselec para la carga de Holding en Cornerstone "
output: html_notebook
---

Librerías

```{r}
library(dplyr)
library(data.table)
library(lubridate)
```

Funciones

```{r}
isValidEmail <- function(x) {
        grepl("\\<[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}\\>", as.character(x), ignore.case=TRUE)
}
```


El objetivo de este script es el filtrado de los datos de origen de e-Preselec ESP para su 
carga en Cornerstone para el ámbito Holding.

En la subcarpeta datos_originales/ están todos los archivos fuente obtenidos de e-Preselec ESP

En la subcarpeta output/ dejaremos los ficheros de salida ya filtrados y limpiados

1. Leemos el fichero de maestro de candidatos y de procesos y nos vamos a guardar una variable con los candidatos que no vamos a poder cargar por estar anonimizados, no tener nombre o no tener email válido

El criterio será NOMBRE != XXXXX o != "" o EMAIL != "" o EMAIL no válido


```{r}
nombre <- "datos_originales/01-Candidatos_Datos_Personales.csv"
fichero_candidatos <- read.csv2(nombre, sep = "~", quote = "", fileEncoding = "UTF-8", stringsAsFactors = TRUE)
candidatos_maestro <- tbl_df(fichero_candidatos)
candidatos_maestro <- filter(candidatos_maestro, NOMBRE != "XXXXXX")
candidatos_maestro <- filter(candidatos_maestro, NOMBRE != "")
candidatos_maestro <- filter(candidatos_maestro, EMAIL != "")
emails_incorectos <- filter(candidatos_maestro,!isValidEmail(EMAIL))
candidatos_maestro <- filter(candidatos_maestro, isValidEmail(EMAIL))
print("Estos son los emails inválidos que hemos eliminado")
print(emails_incorectos$EMAIL)
```

Tampoco vamos a cargar los candidatos que ya están incorporados como empleados

```{r}
candidatos_maestro <- filter(candidatos_maestro, ESTADO != "Incorporado")

```

También vamos a eliminar los candidatos probablemente de prueba que tienen "infojobs" o "infoempleo" en su correo electrónico

```{r}
candidatos_maestro <- filter(candidatos_maestro, !(EMAIL %like% "@infojobs"))
candidatos_maestro <- filter(candidatos_maestro, !(EMAIL %like% "@infoempleo"))
candidatos_maestro <- filter(candidatos_maestro, !(EMAIL %like% "@vacio.com"))
```



De los candidatos duplicados cargaremos únicamente una ocurrencia, la de fecha de actualización más reciente. Estos son alugunos de los repetidos

```{r}
#agrupamos por email
emails_repetidos <- candidatos_maestro %>% group_by(EMAIL) %>%
        summarise(count = n()) %>% 
        arrange(desc(count)) %>% filter(count > 1)
print(emails_repetidos)
```

```{r}

```




Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).
